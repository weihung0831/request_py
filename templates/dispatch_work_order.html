<!DOCTYPE html>
<html lang="zh-TW">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TBI-SMU</title>
    <link rel="stylesheet" href="../static/dist/output.css" />
    <link href="../static/css/flowbite.min.css" rel="stylesheet" />
  </head>

  <body>
    {% include 'nav.html' %}
    <div id="error-alert"></div>
    <div class="flex flex-col items-center px-4 sm:px-6 lg:px-8">
      <p class="text-2xl text-gray-900 dark:text-white mb-10 mt-10">派工單</p>
    </div>
    <div id="card-container" class="flex flex-wrap justify-center -mx-4"></div>
  </body>
  <script src="../static/js/axios.min.js"></script>
  <script>
    // 設定 API 網址
    api_url = "http://127.0.0.1:80/api";

    // 使用 axios 發送 GET 請求
    axios
      .get(`${api_url}/get_dispatch_work_order_data`)
      .then((res) => {
        console.log(res.data);
        const result = res.data.result;

        // 迴圈 result 陣列並為每個工單建立卡片
        result.forEach((resultList, index) => {
          // 填充卡片内容
          let cardHTML = `
            <div class="card w-full max-w-sm h-full flex flex-col justify-between p-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700 mx-4 my-4">
              <div class="flex items-center justify-center">
                <p class="mb-2 text-lg font-bold tracking-tight text-gray-900 dark:text-white">工單編號：</p>
                <p class="mb-2 text-lg font-bold tracking-tight text-gray-900 dark:text-white">${resultList["work_order_number"]}</p>
              </div>
              <div class="flex justify-center">
                <div class="flex items-center mt-4 mb-4 mr-8">
                  <label class="text-gray-700 dark:text-gray-300">訂單數量：</label>
                  <p class="text-gray-700 dark:text-gray-300">${resultList["work_order_quantity"]}</p>
                </div>
                <div class="flex items-center mt-4 mb-4">
                  <label class="text-gray-700 dark:text-gray-300">未交數量：</label>
                  <p class="text-gray-700 dark:text-gray-300">${resultList["undelivered_quantity"]}</p>
                </div>
              </div>
              <div class="flex justify-center">
                <div class="flex items-center mb-4 mr-8">
                  <label class="text-gray-700 dark:text-gray-300">總數量：</label>
                  <p class="text-gray-700 dark:text-gray-300">${resultList["total_quantity"]}</p>
                </div>
                <div class="flex items-center mb-8">
                  <label class="text-gray-700 dark:text-gray-300">剩餘數量：</label>
                  <p class="text-gray-700 dark:text-gray-300" id="remaining_quantity_value_${index}">${resultList["remaining_quantity"]}</p>
                </div>
              </div>
              <form class="max-w-sm mx-auto" id="water_level_form_${index}">
                <div class="flex items-center mb-8">
                  <input type="number" id="water_level_input_${index}" aria-describedby="helper-text-explanation"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center"
                      placeholder="請輸入水位" >
                </div>
                <div class="flex items-center justify-center">
                  <button type="submit" class="py-2.5 px-5 me-2 mb-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-full border border-gray-200 hover:bg-gray-100 hover:text-blue-700 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">送出</button>
                </div>
              </form>
            </div>`;
          // 將卡片添加到 "card-container" 元素的末尾
          document.getElementById("card-container").insertAdjacentHTML("beforeend", cardHTML);
        });
      })
      .catch((err) => {
        console.log(err);
      });

    // 為 id 為 'card-container' 的元素添加 'submit' 事件監聽器
    document.getElementById('card-container').addEventListener('submit', function (e) {
      // 從事件目標中獲取索引
      // Array.from 將 children 轉換為陣列，然後使用 indexOf 方法找到目標卡片在陣列中的索引
      let index = Array.from(e.currentTarget.children).indexOf(e.target.closest('.card'));

      // 檢查索引是否不為 -1（也就是說，我們是否找到了卡片）
      // 並檢查事件目標的 id 是否等於 `water_level_form_${index}`
      if (index !== -1 && e.target && e.target.id === `water_level_form_${index}`) {
        // 防止表單的默認提交行為
        e.preventDefault();

        // 獲取水位輸入欄位
        let waterLevelInput = document.getElementById(`water_level_input_${index}`);
        // 將水位輸入轉換為浮點數，如果輸入欄位不存在，則水位為 0
        let waterLevel = waterLevelInput ? parseFloat(waterLevelInput.value) : 0;

        let alertDiv = document.querySelector('.alert-div');
        // 檢查水位輸入是否為空、無效或小於等於 0
        if (!waterLevelInput.value || isNaN(waterLevel) || waterLevel <= 0) {
          // 建立錯誤訊息
          const error_msg = `
          <div class="flex items-center p-4 mb-4 text-sm text-red-800 border border-red-300 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 dark:border-red-800" role="alert">
            <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
            </svg>
            <span class="sr-only">Info</span>
            <div>
              <span class="font-medium">請輸入有效水位 !</span>
            </div>
          </div>`;
          // 插入錯誤訊息
          var msgElement = document.createElement('div');
          msgElement.innerHTML = error_msg;
          document.getElementById("error-alert").insertAdjacentElement("afterend", msgElement);
          // 設定 2 秒後移除錯誤訊息
          setTimeout(function () {
            msgElement.remove();
          }, 5000);
          // 如果輸入無效，則阻止進一步處理
          return;
        }

        let remainingQuantityValue = 0;

        // 尋找剩餘數量元素，並讀取其值
        const remainingQuantityElement = document.getElementById(`remaining_quantity_value_${index}`);
        if (remainingQuantityElement) {
          remainingQuantityValue = parseFloat(remainingQuantityElement.innerHTML);
        }

        const cardElement = e.target.closest('.card');
        // 檢查水位是否超過剩餘數量
        if (remainingQuantityValue < waterLevel) {
          // 將 card 背景顏色改為紅色
          cardElement.style.backgroundColor = "rgb(169, 68, 56)";
        } else {
          // 將 card 背景顏色改為綠色
          cardElement.style.backgroundColor = "rgb(80, 141, 105)";
        }
      }
    });
  </script>
  <script src="../static/js/flowbite.min.js"></script>

</html>
